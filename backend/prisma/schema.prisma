// Prisma schema para o Backend Financeiro (PostgreSQL)

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

model User {
  id             String           @id @default(uuid())
  email          String           @unique
  passwordHash   String
  fullName       String
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt
  connections    BankConnection[]
  financialGoals FinancialGoal[]
}

model BankConnection {
  id               String   @id @default(uuid())
  userId           String
  user             User     @relation(fields: [userId], references: [id])
  institutionId    String
  institutionName  String
  consentId        String   @unique
  accessToken      String   // Criptografado em repouso
  refreshToken     String?  // Criptografado em repouso
  status           String   // ACTIVE, REVOKED, EXPIRED
  expiresAt        DateTime
  accounts         Account[]
}

model Account {
  id               String        @id @default(uuid())
  connectionId     String
  connection       BankConnection @relation(fields: [connectionId], references: [id])
  type             String        // CHECKING, SAVINGS, CREDIT_CARD
  lastBalance      Decimal       @db.Decimal(15, 2)
  currency         String        @default("BRL")
  transactions     Transaction[]
}

model Transaction {
  id               String   @id @default(uuid())
  accountId        String
  account          Account  @relation(fields: [accountId], references: [id])
  amount           Decimal  @db.Decimal(15, 2)
  date             DateTime
  description      String
  category         String?
  providerId       String?  @unique // ID original da instituição financeira
}

model FinancialGoal {
  id            String   @id @default(uuid())
  userId        String
  user          User     @relation(fields: [userId], references: [id])
  name          String
  targetAmount  Decimal  @db.Decimal(15, 2)
  currentAmount Decimal  @db.Decimal(15, 2) @default(0)
  deadline      DateTime?
}

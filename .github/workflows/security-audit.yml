# Security Audit Pipeline - Senior FinTech
# Executa verificaÃ§Ãµes de seguranÃ§a semanalmente e em PRs

name: Security Audit

on:
  schedule:
    - cron: '0 3 * * 1' # Segunda-feira Ã s 3h
  pull_request:
    branches: [main]
  workflow_dispatch: # Permite execuÃ§Ã£o manual

jobs:
  dependency-check:
    name: ğŸ›¡ï¸ VerificaÃ§Ã£o de DependÃªncias
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout do cÃ³digo
        uses: actions/checkout@v4

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: ğŸ” Auditoria Backend
        working-directory: ./backend
        run: |
          npm ci
          npm audit --audit-level=moderate || true
          
      - name: ğŸ¯ Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.16.0'
          channel: 'stable'

      - name: ğŸ” Verificar dependÃªncias Flutter
        working-directory: ./mobile
        run: |
          flutter pub get
          flutter pub outdated

  secrets-scan:
    name: ğŸ” Scan de Secrets
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout do cÃ³digo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ” Detectar secrets vazados
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: ${{ github.event.repository.default_branch }}
          head: HEAD
          extra_args: --only-verified

  code-quality:
    name: ğŸ“Š Qualidade de CÃ³digo
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout do cÃ³digo
        uses: actions/checkout@v4

      - name: ğŸ” AnÃ¡lise CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: javascript, typescript

      - name: ğŸ”¨ Build para anÃ¡lise
        run: |
          cd backend && npm ci

      - name: ğŸ“Š Executar anÃ¡lise CodeQL
        uses: github/codeql-action/analyze@v3

  compliance-check:
    name: ğŸ“‹ VerificaÃ§Ã£o de Conformidade
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout do cÃ³digo
        uses: actions/checkout@v4

      - name: ğŸ“‹ Verificar documentaÃ§Ã£o de seguranÃ§a
        run: |
          echo "Verificando arquivos de conformidade..."
          
          if [ -f "SECURITY_AUDIT.md" ]; then
            echo "âœ… SECURITY_AUDIT.md encontrado"
          else
            echo "âŒ SECURITY_AUDIT.md nÃ£o encontrado"
            exit 1
          fi
          
          if [ -f "SPECIFICATION.md" ]; then
            echo "âœ… SPECIFICATION.md encontrado"
          else
            echo "âŒ SPECIFICATION.md nÃ£o encontrado"
            exit 1
          fi

      - name: ğŸ·ï¸ Criar issue de revisÃ£o
        if: github.event_name == 'schedule'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'ğŸ”’ RevisÃ£o Semanal de SeguranÃ§a',
              body: `## Auditoria AutomÃ¡tica de SeguranÃ§a\n\nData: ${new Date().toISOString().split('T')[0]}\n\n### Checklist:\n- [ ] Revisar dependÃªncias desatualizadas\n- [ ] Verificar logs de vulnerabilidades\n- [ ] Atualizar certificados se necessÃ¡rio\n- [ ] Revisar permissÃµes de acesso`,
              labels: ['security', 'audit']
            })
